<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Trading Insights Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- TradingView core -->
  <script src="https://s3.tradingview.com/tv.js"></script>

  <!-- App config -->
  <script id="app-config" type="application/json">{
    "API_BASE": "/.netlify/functions",
    "AI_ROUTE": "/.netlify/functions/ai-analyze",
    "AUTO_RUN_ANALYSIS": true
  }</script>

  <style>
    .fade-in { animation: fadeIn .45s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px);} to { opacity: 1; transform: none; } }
    .btn { padding:.5rem 1rem; border-radius:.5rem; background:#2563eb; color:#fff; }
    .btn:hover { background:#3b82f6; }
    .card { background:#0b0e13; border:1px solid #202633; border-radius: .75rem; padding:1rem; }
    .field { width:100%; padding:.75rem; background:#0b0e13; border:1px solid #2a3242; border-radius:.75rem; color:#fff; }
    .field::placeholder { color:#9aa3b2; }
  </style>
</head>

<body class="bg-gray-950 text-white min-h-screen">
  <div class="max-w-7xl mx-auto p-4">
    <!-- Risk banner -->
    <div class="sticky top-0 z-50 bg-red-900/80 border-l-4 border-red-500 p-4 rounded-lg mb-4 fade-in">
      <strong>⚠️ Trading Risk:</strong> Educational use only. Not financial advice.
    </div>

    <!-- Header -->
    <header class="text-center mb-6 fade-in">
      <h1 class="text-4xl md:text-5xl font-bold">AI Trading Dashboard</h1>
      <p class="text-gray-400 mt-1">Quotes, analysis, news, tweets, and events in one view</p>
    </header>

    <!-- Search + toolbar -->
    <section class="mb-5 fade-in">
      <div class="relative">
        <input id="search" class="field" placeholder="Search symbol, try AAPL" />
        <div id="suggest" class="absolute bg-gray-900 border border-gray-700 rounded mt-1 hidden max-h-64 overflow-auto w-full z-10"></div>
      </div>
      <div class="flex flex-wrap gap-3 mt-4">
        <button class="btn" id="refreshBtn">Refresh</button>
        <button class="btn" id="toggleSettingsBtn">Settings</button>
      </div>
    </section>

    <!-- Market overview placeholder -->
    <section id="marketOverview" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 fade-in">
      <div class="card">
        <div class="text-gray-400">Market overview cards go here</div>
      </div>
    </section>

    <!-- Settings -->
    <section id="settings" class="hidden mb-6 card fade-in">
      <h3 class="text-xl font-semibold mb-4">Settings</h3>
      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block mb-1 text-gray-300">Twelve Data Key</label>
          <input id="tdKeyInput" class="field" placeholder="Optional to store client-side. Prefer env on server." />
        </div>
        <div>
          <label class="block mb-1 text-gray-300">Current Symbol</label>
          <input id="asset" class="field" placeholder="e.g., AAPL" />
        </div>
      </div>
      <div class="mt-4">
        <button id="saveSettingsBtn" class="btn">Save</button>
      </div>
      <pre id="settingsLog" class="bg-black/60 rounded p-3 text-sm whitespace-pre-wrap mt-4 max-h-64 overflow-auto"></pre>
    </section>

    <!-- Analysis -->
    <section class="mb-6 card fade-in">
      <h3 class="text-xl font-semibold mb-4">AI Analysis</h3>
      <div class="flex gap-2 mb-3">
        <input id="symbolInput" class="field" placeholder="Symbol for analysis, e.g., AAPL" />
        <button id="runAnalysisBtn" class="btn">Run Analysis</button>
      </div>
      <section id="resultsSection" class="bg-gray-950 border border-gray-800 rounded-xl p-4">
        <h4 class="font-semibold mb-2">Result</h4>
        <div id="analysisResult" class="bg-black/60 rounded p-3 text-sm whitespace-pre-wrap"></div>
      </section>
    </section>

    <!-- TradingView -->
    <section id="tvWidgetsSection" class="mb-6 card fade-in">
      <h3 class="text-xl font-semibold mb-3">Charts</h3>
      <!-- Ticker Tape -->
      <div id="tv_ticker_tape" class="mb-4">
        <div class="tradingview-widget-container">
          <div class="tradingview-widget-container__widget"></div>
          <script type="text/javascript" async
            src="https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js">
            {
              "symbols": [
                {"proName": "NASDAQ:AAPL","title": "AAPL"},
                {"proName": "NASDAQ:NVDA","title": "NVDA"},
                {"proName": "NASDAQ:TSLA","title": "TSLA"},
                {"proName": "NASDAQ:MSFT","title": "MSFT"},
                {"proName": "NASDAQ:AMD","title": "AMD"},
                {"proName": "FOREXCOM:SPXUSD","title": "S&P 500"}
              ],
              "showSymbolLogo": true,
              "isTransparent": false,
              "displayMode": "adaptive",
              "colorTheme": "dark",
              "locale": "en"
            }
          </script>
        </div>
      </div>

      <!-- Main Advanced Chart -->
      <div id="tv_main_chart" style="height:520px" class="rounded overflow-hidden"></div>

      <!-- Symbol Overview -->
      <div id="tv_symbol_overview" class="mt-4 rounded overflow-hidden"></div>
    </section>

    <!-- News and events -->
    <section id="newsEvents" class="mb-6 card fade-in">
      <h3 class="text-xl font-semibold mb-4 flex items-center gap-2">News and Events</h3>
      <div class="flex mb-4">
        <button class="news-tab px-4 py-2 bg-blue-600 rounded-l" data-target="cnbc">CNBC News</button>
        <button class="news-tab px-4 py-2 bg-gray-700" data-target="x">Tweets</button>
        <button class="news-tab px-4 py-2 bg-gray-700 rounded-r" data-target="forex">Forex Calendar</button>
      </div>
      <div id="newsPanels" class="space-y-4">
        <div data-panel="cnbc"></div>
        <div data-panel="x" class="hidden"></div>
        <div data-panel="forex" class="hidden"></div>
      </div>
    </section>

    <footer class="text-center text-gray-500 mt-8">Built for traders. Educational only.</footer>
  </div>

  <script>
    // Config
    const APP_CFG = JSON.parse(document.getElementById("app-config").textContent || "{}");
    const API = APP_CFG.API_BASE || "/.netlify/functions";
    const AI_ROUTE = APP_CFG.AI_ROUTE || "/.netlify/functions/ai-analyze";

    // Helpers
    const qs = (s) => document.querySelector(s);
    const qsa = (s) => Array.from(document.querySelectorAll(s));
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // Backoff fetch if you do not already have it
    if (typeof window.fetchWithBackoff !== "function") {
      window.fetchWithBackoff = async function(url, opts = {}, retries = 2) {
        for (let i = 0; i <= retries; i++) {
          try {
            const ctrl = new AbortController();
            const t = setTimeout(() => ctrl.abort(), 15000);
            const res = await fetch(url, { ...opts, signal: ctrl.signal });
            clearTimeout(t);
            if (!res.ok) throw new Error("HTTP " + res.status);
            return await res.json();
          } catch (e) {
            if (i === retries) throw e;
            await sleep(500 * (i + 1));
          }
        }
      };
    }

    // Settings
    const settingsEl = qs("#settings");
    qs("#toggleSettingsBtn")?.addEventListener("click", () => settingsEl.classList.toggle("hidden"));
    qs("#saveSettingsBtn")?.addEventListener("click", () => {
      const sym = getCurrentSymbol();
      qs("#settingsLog").textContent = "Saved locally. Symbol: " + sym + "\nKeys should live on server only.";
    });

    function getCurrentSymbol() {
      const a = qs("#asset");
      if (a && a.value) return a.value.trim().toUpperCase();
      const b = qs("#symbolInput");
      if (b && b.value) return b.value.trim().toUpperCase();
      if (window.currentSymbol) return String(window.currentSymbol).trim().toUpperCase();
      return "AAPL";
    }

    // Autocomplete
    const search = qs("#search");
    const suggest = qs("#suggest");
    let suggestTimer;
    if (search) {
      search.addEventListener("input", () => {
        clearTimeout(suggestTimer);
        const q = search.value.trim();
        if (q.length < 2) { suggest.classList.add("hidden"); return; }
        suggestTimer = setTimeout(async () => {
          try {
            const data = await fetchWithBackoff(`${API}/search-symbols?q=${encodeURIComponent(q)}`);
            const list = (data?.data || data?.best_matches || data?.matches || data?.symbols || [])
              .map(s => s.symbol || s.instrument || s?.["1. symbol"] || "")
              .filter(Boolean)
              .slice(0, 12);

            suggest.innerHTML = list.map(sym => `<div class="p-2 hover:bg-gray-800 cursor-pointer">${sym}</div>`).join("");
            suggest.classList.remove("hidden");
            Array.from(suggest.children).forEach(row => row.addEventListener("click", () => {
              const sym = row.textContent.trim();
              if (qs("#asset")) qs("#asset").value = sym;
              if (qs("#symbolInput")) qs("#symbolInput").value = sym;
              if (typeof window.setAsset === "function") window.setAsset(sym);
              suggest.classList.add("hidden");
              loadNewsAndEvents(sym);
              loadTradingView(sym);
            }));
          } catch {
            suggest.innerHTML = `<div class="p-2 text-red-400">Search error</div>`;
            suggest.classList.remove("hidden");
          }
        }, 200);
      });
      search.addEventListener("blur", () => setTimeout(() => suggest.classList.add("hidden"), 200));
    }

    // News and events
    async function loadNewsAndEvents(symbol) {
      const sym = (symbol || getCurrentSymbol() || "AAPL").trim().toUpperCase();
      const panelsRoot = qs("#newsPanels");
      if (!panelsRoot) return;

      const cnbcDiv = panelsRoot.querySelector('[data-panel="cnbc"]');
      const xDiv    = panelsRoot.querySelector('[data-panel="x"]');
      const fxDiv   = panelsRoot.querySelector('[data-panel="forex"]');

      if (cnbcDiv) {
        cnbcDiv.innerHTML = `<div class="text-gray-400">Loading CNBC…</div>`;
        try {
          const data = await fetchWithBackoff(`${API}/cnbc-news?symbol=${encodeURIComponent(sym)}`);
          cnbcDiv.innerHTML = (data?.articles || []).map(a => `
            <a href="${a.url}" target="_blank" class="block p-3 bg-gray-800 rounded hover:bg-gray-700">
              <div class="font-medium">${a.title || "Untitled"}</div>
              <div class="text-gray-400 text-sm">${(a?.source?.name || "")} ${(a?.publishedAt || "")}</div>
              <div class="text-gray-300 text-sm mt-1">${a.description || ""}</div>
            </a>
          `).join("") || `<div class="text-gray-400">No news</div>`;
        } catch {
          cnbcDiv.innerHTML = `<div class="text-red-400">News error</div>`;
        }
      }

      if (xDiv) {
        xDiv.innerHTML = `<div class="text-gray-400">Loading Tweets…</div>`;
        try {
          const q = `${sym} lang:en -is:retweet`;
          const data = await fetchWithBackoff(`${API}/x-tweets?q=${encodeURIComponent(q)}`);
          const list = data?.data || data?.tweets || [];
          xDiv.innerHTML = list.map(t => `
            <div class="p-3 bg-gray-800 rounded">
              <div class="text-xs text-gray-400">${new Date(t.created_at).toLocaleString()}</div>
              <div class="mt-1">${t.text || ""}</div>
            </div>
          `).join("") || `<div class="text-gray-400">No tweets or token missing</div>`;
        } catch {
          xDiv.innerHTML = `<div class="text-red-400">Tweets error</div>`;
        }
      }

      if (fxDiv) {
        fxDiv.innerHTML = `<div class="text-gray-400">Loading Forex…</div>`;
        try {
          const today = new Date().toISOString().slice(0,10);
          const data = await fetchWithBackoff(`${API}/forex-calendar?date=${today}`);
          const events = data?.events || [];
          fxDiv.innerHTML = events.slice(0, 15).map(ev => `
            <div class="p-3 bg-gray-800 rounded">
              <div class="font-medium">${ev.title || ev.event || "Event"}</div>
              <div class="text-gray-400 text-sm">${ev.time || ""} • Impact ${ev.impact || ev.importance || ""}</div>
              <div class="text-gray-300 text-sm">${ev.country || ""} ${ev.currency || ""}</div>
            </div>
          `).join("") || `<div class="text-gray-400">No events</div>`;
        } catch {
          fxDiv.innerHTML = `<div class="text-red-400">Forex error</div>`;
        }
      }
    }
    window.loadNewsAndEvents = loadNewsAndEvents;

    // Tabs
    qsa(".news-tab").forEach(btn => {
      btn.addEventListener("click", () => {
        qsa(".news-tab").forEach(b => b.classList.remove("bg-blue-600"));
        btn.classList.add("bg-blue-600");
        const target = btn.dataset.target;
        qsa("#newsPanels [data-panel]").forEach(p => p.classList.add("hidden"));
        qs(`#newsPanels [data-panel="${target}"]`)?.classList.remove("hidden");
      });
    });

    // OpenAI analysis via serverless route
    qs("#runAnalysisBtn")?.addEventListener("click", async () => {
      const sym = getCurrentSymbol();
      const out = qs("#analysisResult");
      out.textContent = "Running analysis for " + sym + "…";
      try {
        const tweetsForPrompt = await (async () => {
          try {
            const q = `${sym} lang:en -is:retweet`;
            const data = await fetchWithBackoff(`${API}/x-tweets?q=${encodeURIComponent(q)}`);
            const list = data?.data || data?.tweets || [];
            return list.slice(0,5).map(t => `• ${t.text}`).join("\n");
          } catch { return ""; }
        })();

        const body = {
          symbol: sym,
          prompt: `Analyze ${sym}. Give bias, structure, key levels, catalysts. Be concise.`,
          context: tweetsForPrompt ? `Tweets:\n${tweetsForPrompt}` : ""
        };

        const res = await fetch(AI_ROUTE, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error("AI route error " + res.status);
        const data = await res.json();
        out.textContent = data.text || JSON.stringify(data, null, 2);
      } catch (e) {
        out.textContent = "Analysis error: " + String(e?.message || e);
      }
    });

    // TradingView widgets
    function loadTradingView(symbol) {
      const sym = (symbol || getCurrentSymbol() || "AAPL").toUpperCase();

      // Main Advanced Chart
      const chartEl = document.getElementById("tv_main_chart");
      if (chartEl) {
        chartEl.innerHTML = ""; // reset container
        new TradingView.widget({
          autosize: true,
          symbol: sym,
          interval: "60",
          timezone: "Etc/UTC",
          theme: "dark",
          style: "1",
          locale: "en",
          toolbar_bg: "#1a2030",
          enable_publishing: false,
          allow_symbol_change: true,
          container_id: "tv_main_chart",
          studies: ["MASimple@tv-basicstudies", "MAExp@tv-basicstudies"]
        });
      }

      // Symbol Overview (multi symbol)
      const ovEl = document.getElementById("tv_symbol_overview");
      if (ovEl) {
        ovEl.innerHTML = `
          <div class="tradingview-widget-container">
            <div class="tradingview-widget-container__widget"></div>
            <script type="text/javascript" async src="https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js">
            {
              "symbols": [
                ["${sym}|1D"], ["NASDAQ:NVDA|1D"], ["NASDAQ:TSLA|1D"], ["NASDAQ:MSFT|1D"], ["NASDAQ:AMD|1D"]
              ],
              "chartOnly": false,
              "width": "100%",
              "height": "380",
              "locale": "en",
              "colorTheme": "dark",
              "autosize": true,
              "showVolume": true,
              "showMA": true,
              "hideDateRanges": false,
              "hideMarketStatus": false,
              "hideSymbolLogo": false,
              "scalePosition": "right",
              "scaleMode": "Normal",
              "fontFamily": "-apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, sans-serif",
              "fontSize": "12",
              "noTimeScale": false,
              "valuesTracking": "1",
              "changeMode": "price-and-percent",
              "chartType": "area"
            }
            </script>
          </div>
        `;
      }
    }
    window.loadTradingView = loadTradingView;

    // Refresh
    qs("#refreshBtn")?.addEventListener("click", () => {
      const sym = getCurrentSymbol();
      loadNewsAndEvents(sym);
      loadTradingView(sym);
    });

    // First paint
    window.addEventListener("DOMContentLoaded", () => {
      if (qs("#asset") && !qs("#asset").value) qs("#asset").value = "AAPL";
      if (qs("#symbolInput") && !qs("#symbolInput").value) qs("#symbolInput").value = "AAPL";
      const sym = getCurrentSymbol();
      loadNewsAndEvents(sym);
      loadTradingView(sym);
      if (APP_CFG.AUTO_RUN_ANALYSIS) qs("#runAnalysisBtn")?.click();
    });
  </script>
</body>
</html>
