<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  />
  <title>AI Trading Insights Dashboard</title>

  <!-- App config (read-only; do NOT put secrets here) -->
  <script id="app-config" type="application/json">{
    "API_BASE": "/.netlify/functions",
    "USE_PROXY": true,
    "AUTO_RUN_ANALYSIS": true
  }</script>

  <style>
    /* --- Global / layout --- */
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family: -apple-system, BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background: linear-gradient(135deg,#0f1419 0%,#1e3a8a 50%,#0f1419 100%);
      color:#fff; min-height:100vh;
    }
    .container { max-width:1200px; margin:0 auto; padding:20px }

    .header { text-align:center; margin-bottom:24px }
    .header h1 {
      font-size:2.4rem; margin-bottom:8px;
      background:linear-gradient(45deg,#3b82f6,#10b981);
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
    }
    .header p { color:#94a3b8; font-size:1.02rem }

    .toolbar { display:flex; gap:10px; justify-content:center; margin:14px 0 26px; flex-wrap:wrap }
    .btn { background:#374151; color:#fff; border:1px solid #4b5563; padding:8px 14px; border-radius:8px; cursor:pointer; font-size:.9rem }
    .btn:hover { background:#4b5563 }

    .analysis-section { background:rgba(30,41,59,.8); border:1px solid #334155; border-radius:12px; padding:24px; margin-bottom:24px }
    .analysis-section h3 { margin-bottom:14px; display:flex; align-items:center; gap:10px }

    .market-overview {
      display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px; margin-bottom:24px
    }
    .stock-card { background:rgba(30,41,59,.8); border:1px solid #334155; border-radius:12px; padding:20px; transition:.2s }
    .stock-card.clickable{ cursor:pointer }
    .stock-card.clickable:hover{ transform:translateY(-2px); border-color:#3b82f6 }
    .stock-symbol { font-weight:700; font-size:1.05rem; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center }
    .stock-price { font-size:1.55rem; font-weight:700; margin-bottom:6px }
    .stock-change { font-size:.9rem }
    .stock-details { font-size:.85rem; color:#94a3b8; margin-top:8px }
    .positive{ color:#10b981 } .negative{ color:#ef4444 }

    .input-group { margin-bottom:14px }
    .input-group label { display:block; margin-bottom:8px; font-weight:500 }
    .input-row { display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center }
    .input-group input {
      width:100%; padding:12px; background:#1e293b; border:1px solid #475569; border-radius:8px; color:#fff; font-size:1rem
    }
    .quick-symbols{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap }
    .symbol-btn{ background:#374151; color:#fff; border:1px solid #4b5563; padding:8px 16px; border-radius:6px; cursor:pointer; font-size:.9rem }
    .symbol-btn:hover{ background:#4b5563; transform:translateY(-1px) }

    .prompt-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-bottom:24px }
    .prompt-card{ background:rgba(30,41,59,.8); border:1px solid #334155; border-radius:12px; padding:20px; cursor:pointer; transition:.25s }
    .prompt-card:hover{ transform:translateY(-4px); border-color:#3b82f6; box-shadow:0 10px 25px rgba(59,130,246,.18) }
    .prompt-icon{ width:40px; height:40px; border-radius:8px; display:flex; align-items:center; justify-content:center; margin-bottom:15px; font-size:1.2rem }
    .blue{background:#3b82f6}.green{background:#10b981}.orange{background:#f59e0b}.purple{background:#8b5cf6}.red{background:#ef4444}.indigo{background:#6366f1}.teal{background:#14b8a6}.yellow{background:#eab308}

    .analysis-result{ background:rgba(15,23,42,.9); border:1px solid #475569; border-radius:8px; padding:20px; margin-top:10px; white-space:pre-wrap; line-height:1.6 }
    .loading{ display:flex; align-items:center; gap:10px; color:#94a3b8 }
    .spinner{ width:20px; height:20px; border:2px solid #334155; border-top:2px solid #3b82f6; border-radius:50%; animation:spin 1s linear infinite }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

    .live-indicator{ display:inline-block; width:8px; height:8px; background:#10b981; border-radius:50%; animation:pulse 2s infinite }
    @keyframes pulse{ 0%{opacity:1} 50%{opacity:.5} 100%{opacity:1} }
    .note{ color:#94a3b8; font-size:.9rem }
    .footer{ text-align:center; color:#64748b; margin-top:24px; font-size:.9rem }
    .code{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
    .kv{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .switch{ display:flex; gap:8px; align-items:center }
    .switch input{ transform:scale(1.1) }

    /* Risk banner */
    #riskBanner .box{ background:#1f2937; border:1px solid #ef4444; color:#fff; border-left:6px solid #ef4444; border-radius:10px; padding:12px 14px }

    /* TradingView credit */
    .tradingview-widget-copyright{ display:none !important }

    /* Pro analysis cards (for later features) */
    .analysis-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px }
    .pro-card{ background:rgba(30,41,59,.8); border:1px solid #334155; border-radius:12px; padding:16px; cursor:pointer; transition:.2s }
    .pro-card:hover{ transform:translateY(-3px); border-color:#3b82f6 }
    .signal-badge{ display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700 }
    .signal-buy{ background:#10b981; color:#fff } .signal-sell{ background:#ef4444; color:#fff } .signal-hold{ background:#f59e0b; color:#fff }
    .conf-bar{ background:#334155; height:8px; border-radius:4px; overflow:hidden }
    .conf-fill{ background:linear-gradient(90deg,#10b981,#3b82f6); height:100% }

    @media (max-width:768px){
      .container{ padding:15px }
      .header h1{ font-size:2rem }
      .prompt-grid{ grid-template-columns:1fr }
      .market-overview{ grid-template-columns:1fr }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Persistent, non-dismissible risk banner -->
    <div id="riskBanner" style="position:sticky; top:0; z-index:50; margin:-6px 0 16px 0">
      <div class="box">
        <strong>‚ö†Ô∏è Trading Risk:</strong> This app is for education only. Signals are simplified and can be wrong.
        Use strict position sizing (1‚Äì2% risk per trade), set stops, and verify data freshness pills in the UI.
      </div>
    </div>

    <div class="header">
      <h1>AI Trading Insights Dashboard</h1>
      <p>Stop guessing, start analyzing with AI-powered trading insights</p>
    </div>

    <div class="toolbar">
      <button class="btn" id="refreshBtn">üîÑ Refresh Watchlist</button>
      <button class="btn" id="selfTestBtn">‚úÖ Run Self Tests</button>
      <button class="btn" id="toggleSettingsBtn">‚öôÔ∏è Settings</button>
    </div>

    <!-- Live ticker -->
    <div id="tvTickerWrap" class="analysis-section" style="padding:10px 14px; margin-top:-8px">
      <div id="tvTicker" class="tradingview-widget-container" style="height:44px"></div>
    </div>

    <!-- Overview -->
    <div class="market-overview" id="marketOverview"></div>

    <!-- Settings -->
    <div class="analysis-section" id="settings" style="display:none">
      <h3><span style="background:#3b82f6;width:20px;height:20px;border-radius:4px;display:inline-block"></span> Settings</h3>
      <div class="kv">
        <label class="code">Twelve Data API Key</label>
        <input id="tdKeyInput" placeholder="Paste your Twelve Data key" style="flex:1;max-width:460px" />
        <span class="note">(Used only if you toggle direct mode; otherwise we call your serverless proxy)</span>
      </div>
      <div class="kv" style="margin-top:10px">
        <label class="code">OpenAI Proxy Endpoint</label>
        <input id="openaiEndpointInput" placeholder="/.netlify/functions/openai" style="flex:1;max-width:460px" />
        <span class="note">(Server endpoint that forwards to OpenAI ‚Äî do not put your secret in the browser)</span>
      </div>
      <div class="kv" style="margin-top:10px">
        <div class="switch"><input type="checkbox" id="tdDirectCheckbox" /><label>Use direct Twelve Data (no proxy)</label></div>
        <div class="switch"><input type="checkbox" id="autoRunCheckbox" /><label>Auto-run analysis on Quick select & card click</label></div>
      </div>
      <div style="margin-top:12px"><button class="btn" id="saveSettingsBtn">üíæ Save Settings</button></div>
      <p class="note" style="margin-top:10px">
        Client will call <span class="code">/.netlify/functions/quote</span> ‚Ä¢
        <span class="code">/.netlify/functions/timeseries</span> ‚Ä¢
        <span class="code">/.netlify/functions/openai</span> when direct mode is OFF.
      </p>
      <pre id="settingsLog" class="analysis-result" style="max-height:200px; overflow:auto"></pre>
    </div>

    <!-- Asset Analysis -->
    <div class="analysis-section">
      <h3>
        <span style="background:#3b82f6;width:20px;height:20px;border-radius:4px;display:inline-block"></span>
        Asset Analysis
      </h3>
      <div class="input-group">
        <label for="assetInput">Asset symbol</label>
        <div class="input-row">
          <input id="assetInput" placeholder="e.g., AAPL, NVDA, SPY" />
          <button class="btn" id="analyzeNowBtn">Run Analysis</button>
        </div>
        <div class="quick-symbols" id="quickSymbols">
          <span style="color:#94a3b8;font-size:.9rem;margin-right:10px">Quick select:</span>
          <button class="symbol-btn" data-sym="AAPL">AAPL</button>
          <button class="symbol-btn" data-sym="MSFT">MSFT</button>
          <button class="symbol-btn" data-sym="GOOGL">GOOGL</button>
          <button class="symbol-btn" data-sym="AMZN">AMZN</button>
          <button class="symbol-btn" data-sym="META">META</button>
          <button class="symbol-btn" data-sym="NVDA">NVDA</button>
          <button class="symbol-btn" data-sym="TSLA">TSLA</button>
          <button class="symbol-btn" data-sym="NFLX">NFLX</button>
          <button class="symbol-btn" data-sym="QQQ">QQQ</button>
          <button class="symbol-btn" data-sym="SPY">SPY</button>
          <button class="symbol-btn" data-sym="NAS100">NAS100</button>
        </div>
      </div>
    </div>

    <!-- Prompt Cards -->
    <div class="prompt-grid">
      <div class="prompt-card" data-analysis="market-conditions"><div class="prompt-icon blue">üìà</div><h3>Market Conditions</h3><p>Data-driven view & scenarios</p></div>
      <div class="prompt-card" data-analysis="position-logic"><div class="prompt-icon green">üß†</div><h3>Position Logic</h3><p>Entries, exits, risk mgmt</p></div>
      <div class="prompt-card" data-analysis="news-impact"><div class="prompt-icon orange">‚ö†Ô∏è</div><h3>News Impact</h3><p>What‚Äôs priced in?</p></div>
      <div class="prompt-card" data-analysis="technical-indicators"><div class="prompt-icon purple">üìä</div><h3>Technical Indicators</h3><p>Levels & momentum</p></div>
      <div class="prompt-card" data-analysis="decision-pros-cons"><div class="prompt-icon red">üéØ</div><h3>Decision Pros & Cons</h3><p>Balanced view</p></div>
      <div class="prompt-card" data-analysis="emerging-trends"><div class="prompt-icon indigo">üîç</div><h3>Emerging Trends</h3><p>What‚Äôs forming?</p></div>
      <div class="prompt-card" data-analysis="strategy-simplification"><div class="prompt-icon teal">üìö</div><h3>Strategy Simplified</h3><p>Step-by-step plan</p></div>
      <div class="prompt-card" data-analysis="risk-assessment"><div class="prompt-icon yellow">üí∞</div><h3>Risk Assessment</h3><p>Vol, liquidity, events</p></div>
    </div>

    <!-- AI Results -->
    <div class="analysis-section" id="resultsSection" style="display:none;">
      <h3><span style="background:#3b82f6;width:20px;height:20px;border-radius:4px;display:inline-block"></span> AI Analysis Results</h3>
      <div style="margin:-4px 0 8px 0;color:#fbbf24;font-size:.9rem">
        Limitations: analysis uses simplified formulas & public data‚Äîeducational only, not financial advice.
      </div>
      <div id="analysisResult" class="analysis-result"></div>
    </div>

    <!-- TradingView -->
    <div class="analysis-section" id="tvWidgetsSection">
      <h3><span style="background:#3b82f6;width:20px;height:20px;border-radius:8px;display:inline-block"></span> Live Markets</h3>

      <div id="tvAdvancedWrap" style="height:520px; border:1px solid #334155; border-radius:8px; margin-bottom:16px; overflow:hidden">
        <div class="tradingview-widget-container" id="tvAdvanced"></div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap:16px">
        <div class="tradingview-widget-container" id="tvOverview" style="min-height:380px; border:1px solid #334155; border-radius:8px; overflow:hidden"></div>
        <div class="tradingview-widget-container" id="tvTimeline" style="min-height:380px; border:1px solid #334155; border-radius:8px; overflow:hidden"></div>
        <div class="tradingview-widget-container" id="tvEvents" style="min-height:380px; border:1px solid #334155; border-radius:8px; overflow:hidden"></div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap:16px; margin-top:16px">
        <div class="tradingview-widget-container" id="tvScreener" style="min-height:550px; border:1px solid #334155; border-radius:8px; overflow:hidden"></div>
        <div class="tradingview-widget-container" id="tvHeatmap" style="min-height:550px; border:1px solid #334155; border-radius:8px; overflow:hidden"></div>
      </div>

      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap:16px; margin-top:16px">
        <div class="tradingview-widget-container" id="tvQuotes" style="min-height:550px; border:1px solid #334155; border-radius:8px; overflow:hidden"></div>
        <div class="tradingview-widget-container" id="tvTechnicals" style="min-height:450px; border:1px solid #334155; border-radius:8px; overflow:hidden"></div>
      </div>
    </div>

    <div class="footer">
      <p>üöÄ Built with AI-powered insights ‚Ä¢ Twelve Data (proxy or direct) + OpenAI</p>
    </div>
  </div>

  <script>
    /* ==============================
       CONFIG / STATE
    ===============================*/
    const APP_CFG = (() => {
      const el = document.getElementById('app-config');
      try {
        return Object.assign(
          { API_BASE: '/.netlify/functions', USE_PROXY:true, AUTO_RUN_ANALYSIS:true },
          JSON.parse(el?.textContent || '{}')
        );
      } catch {
        return { API_BASE: '/.netlify/functions', USE_PROXY:true, AUTO_RUN_ANALYSIS:true };
      }
    })();
    const API = APP_CFG.API_BASE;

    const settings = {
      tdKey: localStorage.getItem('TD_KEY') || '',
      tdDirect: JSON.parse(localStorage.getItem('TD_DIRECT') || 'false'),
      openaiEndpoint: localStorage.getItem('OPENAI_ENDPOINT') || `${API}/openai`,
      autoRun: JSON.parse(localStorage.getItem('AUTO_RUN') || JSON.stringify(APP_CFG.AUTO_RUN_ANALYSIS))
    };

    const CACHE_MS = 5 * 60 * 1000;
    const marketDataCache = new Map();
    const analysisCache = new Map();

    /* ==============================
       UI HELPERS
    ===============================*/
    const settingsLog = (msg) => {
      const el = document.getElementById('settingsLog');
      if(el){ el.textContent += `${new Date().toLocaleTimeString()}  ${msg}\n`; el.scrollTop = el.scrollHeight; }
    };
    const sleep = (ms)=> new Promise(r=>setTimeout(r,ms));

    function ageMeta(iso){
      const ageMs = Date.now() - new Date(iso).getTime();
      const min = Math.floor(ageMs/60000);
      const color = ageMs < 5*60*1000 ? '#10b981' : ageMs < 30*60*1000 ? '#f59e0b' : '#ef4444';
      const label = min < 1 ? '<1m' : `${min}m`;
      return {label, color, ageMs};
    }
    function reliabilityScore(source){
      return source.includes('Twelve Data') ? 0.9 : source.includes('Proxy') ? 0.7 : 0.5;
    }

    /* ==============================
       ROBUST FETCH + CIRCUIT BREAKER
    ===============================*/
    async function parseJsonOrThrow(res){
      const ct = res.headers.get('content-type') || '';
      if(ct.includes('application/json')) return res.json();
      const text = await res.text();
      const msg = text.slice(0, 300);
      throw new Error(`Non-JSON from backend. Is your proxy deployed? First 300 chars: ${msg}`);
    }

    const HEALTH = { failures:{}, open:{} }; // {key:count}, {key:untilTs}
    const jitter = (ms)=> ms*(0.7 + Math.random()*0.6);

    async function fetchWithBackoff(url, opts={}, attempts=4, base=400, key=url){
      if(HEALTH.open[key] && Date.now() < HEALTH.open[key]) {
        throw new Error('CircuitOpen');
      }
      let lastErr;
      for(let i=0;i<attempts;i++){
        try{
          const res = await fetch(url, opts);
          if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const json = await parseJsonOrThrow(res);
          HEALTH.failures[key] = 0;
          return json;
        }catch(e){
          lastErr = e;
          HEALTH.failures[key] = (HEALTH.failures[key]||0)+1;
          const delay = jitter(base * Math.pow(2,i));
          settingsLog(`Retry ${i+1}/${attempts} ‚Üí ${key} : ${e.message} (wait ${Math.round(delay)}ms)`);
          if(i<attempts-1) await sleep(delay);
        }
      }
      if(HEALTH.failures[key] >= 5){ HEALTH.open[key] = Date.now() + 60_000; } // open for 60s
      throw lastErr;
    }

    // Health dashboard
    setInterval(()=>{
      const open = Object.entries(HEALTH.open).filter(([_,ts])=>Date.now()<ts).map(([k,ts])=>`‚Ä¢ ${k} (until ${new Date(ts).toLocaleTimeString()})`).join('\n') || 'none';
      const fails = Object.entries(HEALTH.failures).filter(([_,n])=>n>0).map(([k,n])=>`‚Ä¢ ${k}: ${n}`).join('\n') || 'none';
      settingsLog(`Health ‚Üí open circuits:\n${open}\nfailures:\n${fails}`);
    }, 20000);

    /* ==============================
       DATA SOURCES / QUOTES
    ===============================*/
    const baseMap = {
      AAPL:{ price:192.53, high:194.15, low:191.27, volume:41250000, name:'Apple Inc.' },
      TSLA:{ price:248.98, high:253.50, low:247.80, volume:67890000, name:'Tesla Inc.' },
      NVDA:{ price:877.15, high:882.50, low:870.30, volume:35670000, name:'NVIDIA Corp.' },
      SPY:{ price:474.82, high:475.45, low:473.20, volume:45230000, name:'SPDR S&P 500 ETF' },
      QQQ:{ price:391.25, high:392.80, low:389.45, volume:28450000, name:'Invesco QQQ ETF' },
      MSFT:{ price:431.20, high:433.10, low:428.50, volume:22180000, name:'Microsoft Corp.' },
      GOOGL:{ price:175.32, high:177.20, low:174.80, volume:19850000, name:'Alphabet Inc.' },
      AMZN:{ price:178.25, high:181.5, low:177.8, volume:28940000, name:'Amazon.com Inc.' },
      META:{ price:515.75, high:518.9, low:512.3, volume:15670000, name:'Meta Platforms Inc.' },
      NFLX:{ price:487.92, high:492.1, low:485.2, volume:12850000, name:'Netflix Inc.' },
      NAS100:{ price:17750, high:17890, low:17680, volume:0, name:'NASDAQ-100 Index (NDX)'}
    };
    function mapSymbol(sym){ return sym.toUpperCase()==='NAS100' ? 'NDX' : sym; }

    function validateQuote(q){
      if(!q || !isFinite(q.price) || q.price<=0) throw new Error('Invalid price');
      if(q.high && q.low && q.high < q.low) throw new Error('HL inverted');
      return q;
    }

    async function fetchQuote(symbol){
      const sym = symbol.toUpperCase();
      const key = `Q_${sym}`;
      const cached = JSON.parse(localStorage.getItem(key)||'null');
      if(cached && (Date.now()-new Date(cached.ts).getTime()) < CACHE_MS) return cached.data;

      try{
        let data;
        if(settings.tdDirect){
          if(!settings.tdKey) throw new Error('No Twelve Data key (Settings)');
          const url = `https://api.twelvedata.com/quote?symbol=${encodeURIComponent(mapSymbol(sym))}&apikey=${encodeURIComponent(settings.tdKey)}`;
          const j = await fetchWithBackoff(url,{},4,400,`td:quote:${sym}`);
          if(j.status==='error' || j.code) throw new Error(j.message||'Twelve Data error');
          const price = parseFloat(j.close ?? j.price);
          const prev = parseFloat(j.previous_close ?? j.open ?? price);
          data = validateQuote({
            symbol:sym, name:j.name || sym, price,
            change: price - prev, changePercent: prev ? ((price - prev)/prev)*100 : 0,
            high: +(j.high ?? price), low: +(j.low ?? price), volume: +(j.volume || 0),
            lastUpdate: new Date().toISOString(), source:'Twelve Data (Direct)'
          });
        } else {
          const j = await fetchWithBackoff(`${API}/quote?symbol=${encodeURIComponent(mapSymbol(sym))}`,{},4,400,`fx:quote:${sym}`);
          const price = +( j.price ?? j.close ?? j.last ?? 0 );
          const change = +( j.change ?? j.change_value ?? 0 );
          const changePct = +( j.changePercent ?? j.percent_change ?? j.change_percent ?? 0 );
          data = validateQuote({
            symbol:sym, name: j.name || j.companyName || sym, price,
            change, changePercent: changePct,
            high: +(j.high ?? price), low: +(j.low ?? price), volume: +(j.volume ?? 0),
            lastUpdate: j.updated || j.lastUpdate || new Date().toISOString(),
            source: j.source || 'Proxy'
          });
        }
        localStorage.setItem(key, JSON.stringify({ ts:new Date().toISOString(), data }));
        return data;
      }catch(e){
        settingsLog(`‚ö†Ô∏è quote fallback for ${sym}: ${e.message}`);
        const base = baseMap[sym] || { price:100, high:101, low:99, volume:0, name:sym };
        return { symbol:sym, price:base.price, high:base.high, low:base.low, volume:base.volume, change:0, changePercent:0, name:base.name, lastUpdate:new Date().toISOString(), source:'‚ö†Ô∏è Local Fallback (stale)' };
      }
    }

    /* ==============================
       HISTORICAL CANDLES / INDICATORS
    ===============================*/
    async function loadCandles(symbol, interval='1day', limit=250){
      const u = `${API}/timeseries?symbol=${encodeURIComponent(mapSymbol(symbol))}&interval=${interval}&limit=${limit}`;
      const j = await fetchWithBackoff(u,{},4,400,`ts:${interval}`);
      return j.candles || j.values || j || [];
    }

    function rsi14(candles){
      const closes = candles.map(c=>+c.close);
      if(closes.length<15) return null;
      let gains=0, losses=0;
      for(let i=1;i<=14;i++){
        const ch = closes[i]-closes[i-1];
        gains += ch>0? ch:0; losses += ch<0? -ch:0;
      }
      let avgG=gains/14, avgL=losses/14;
      for(let i=15;i<closes.length;i++){
        const ch = closes[i]-closes[i-1];
        avgG = (avgG*13 + (ch>0?ch:0))/14;
        avgL = (avgL*13 + (ch<0?-ch:0))/14;
      }
      const rs = avgL===0 ? 100 : avgG/avgL;
      return 100 - 100/(1+rs);
    }

    function atr14(candles){
      if(candles.length<15) return null;
      const TR = [];
      for(let i=0;i<candles.length;i++){
        const c = candles[i], p = candles[i-1];
        const hl = c.high - c.low;
        const hc = p ? Math.abs(c.high - p.close) : 0;
        const lc = p ? Math.abs(c.low - p.close) : 0;
        TR.push(Math.max(hl, hc, lc));
      }
      let atr = TR.slice(1,15).reduce((a,b)=>a+b,0)/14;
      for(let i=15;i<TR.length;i++){ atr = (atr*13 + TR[i])/14; }
      return atr;
    }

    async function multiTF(sym){
      const tf = [['1m',120],['5m',240],['1hour',240],['1day',250],['1week',260]];
      const out = {};
      for(const [i, n] of tf){
        try{
          const c = await loadCandles(sym,i,n);
          out[i] = { rsi:rsi14(c), atr: atr14(c) };
        }catch{ out[i] = { rsi:null, atr:null }; }
      }
      return out;
    }

    /* ==============================
       OPENAI (proxy)
    ===============================*/
    function FIN_PROMPTS(sym, ctx){
      return {
        'market-conditions': `
You are a cautious sell-side strategist. Use the data below. Provide scoped, risk-adjusted takeaways with uncertainties.

Symbol: ${sym}
Spot: ${ctx.price}  H:${ctx.high}  L:${ctx.low}  Vol:${ctx.volume}
Indicators: RSI14=${ctx.rsi??'n/a'}  ATR14=${ctx.atr??'n/a'}  Regime=${ctx.regime??'n/a'}

Tasks:
1) Regime: bull/bear/sideways (why)
2) Key levels (support/resistance with numbers)
3) Three likely scenarios (probabilities total 100%)
4) Risks & invalidation
5) Position sizing guidance (1‚Äì2% risk rule)
        `,
        'position-logic': `
Given ${sym} @ ${ctx.price}, ATR14=${ctx.atr??'n/a'}, RSI14=${ctx.rsi??'n/a'}:
- Provide entry/exit logic, stops, targets.
- Explain assumptions & uncertainties. Keep it risk-first.
        `,
        'news-impact': `
For ${sym} snapshot (price ${ctx.price}, vol ${ctx.volume}), outline what news might be priced in,
and separate "hypothesis vs evidence". List key risks that could invert the thesis quickly.
        `,
        'technical-indicators': `
For ${sym}, summarize trend, momentum, and numeric S/R levels using RSI14=${ctx.rsi??'n/a'} and ATR14=${ctx.atr??'n/a'}.
        `,
        'decision-pros-cons': `
Give a balanced list of pros/cons for initiating a position in ${sym} now (spot ${ctx.price}), with risk-reward context.
        `,
        'emerging-trends': `Emerging trends for ${sym} and the sector; what to watch next week.`,
        'strategy-simplification': `Provide a simple, rules-based trading plan for ${sym}: entries, exits, sizing, review cadence.`,
        'risk-assessment': `Assess risk for ${sym}‚Äîvolatility, liquidity, correlation, calendar‚Äîthen mitigation steps.`
      };
    }

    async function callOpenAI(prompt, market){
      const cacheKey = `${prompt.substring(0,60)}_${market.symbol}_${market.price}`;
      const hit = analysisCache.get(cacheKey);
      if(hit && (Date.now()-hit.ts) < CACHE_MS) return hit.data;

      try{
        const r = await fetch(settings.openaiEndpoint, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ prompt, model: "gpt-5-thinking", max_tokens: 600 })
        });
        if(!r.ok) throw new Error(`OpenAI endpoint ${r.status}`);
        const j = await r.json();
        const content = j.text || j.content || j.choices?.[0]?.message?.content || '';
        analysisCache.set(cacheKey, { data: content, ts: Date.now() });
        return content || "**AI returned empty text**";
      }catch(e){
        settingsLog(`‚ö†Ô∏è OpenAI call failed: ${e.message}`);
        return `**AI unavailable** ‚Äî snapshot for ${market.symbol}: Price $${market.price.toFixed(2)}, range ${market.low.toFixed(2)}‚Äì${market.high.toFixed(2)}, vol ${market.volume.toLocaleString()}.`;
      }
    }

    /* ==============================
       UI ACTIONS
    ===============================*/
    function setAsset(symbol){
      const s = symbol.toUpperCase();
      document.getElementById('assetInput').value = s;
      localStorage.setItem('LAST_SYMBOL', s);
      location.hash = s;
      try{ renderTVAdvanced(s); }catch(_){ }
      if(settings.autoRun){ runAnalysis('market-conditions'); }
    }
    window.setAsset = setAsset;

    async function initializeMarketOverview(){
      const container = document.getElementById('marketOverview');
      const watch = ['AAPL','MSFT','GOOGL','AMZN','META','NVDA','TSLA','NFLX','QQQ','SPY','NAS100'];
      container.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:#94a3b8"><div class="spinner" style="margin:0 auto 15px"></div><p>Loading real-time market data...</p></div>`;
      try{
        const results = await Promise.all(watch.map(async s => ({ s, d: await fetchQuote(s) })));
        container.innerHTML = '';
        for(const {s, d} of results){
          const el = document.createElement('div'); el.className = 'stock-card clickable';
          const cls = d.change >= 0 ? 'positive' : 'negative'; const sign = d.change >= 0 ? '+' : '';
          const age = ageMeta(d.lastUpdate);
          const relPct = Math.round(reliabilityScore(d.source)*100);
          el.innerHTML = `
            <div class="stock-symbol">${s}<span class="live-indicator" title="${d.source}"></span></div>
            <div style="font-size:.78rem;color:#94a3b8;margin-bottom:6px">${d.name||s}</div>
            <div class="stock-price">${Number(d.price).toFixed(2)}</div>
            <div class="stock-change ${cls}">${sign}${Number(d.change).toFixed(2)} (${sign}${Number(d.changePercent).toFixed(2)}%)</div>
            <div class="stock-details">
              H: ${Number(d.high).toFixed(2)} L: ${Number(d.low).toFixed(2)} ¬∑ Vol: ${(d.volume||0).toLocaleString()} ¬∑
              <span style="padding:2px 8px;border-radius:999px;background:${age.color};color:#0b1020;font-weight:700">${age.label}</span>
              <span title="data source reliability" style="margin-left:8px;color:#94a3b8">SRC:${relPct}%</span>
            </div>`;
          el.onclick = () => setAsset(s);
          container.appendChild(el);
        }
        const refresh = document.createElement('div');
        refresh.className = 'stock-card clickable';
        refresh.style.display='flex'; refresh.style.flexDirection='column'; refresh.style.alignItems='center'; refresh.style.justifyContent='center';
        refresh.innerHTML = `<div style="font-size:1.6rem;margin-bottom:6px">üîÑ</div><div style="font-size:.95rem">Refresh</div>`;
        refresh.onclick = ()=>{ marketDataCache.clear(); initializeMarketOverview(); };
        container.appendChild(refresh);
      }catch(err){
        console.error('Overview error', err);
        container.innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:40px;color:#ef4444"><p>Error loading market data. Please check Settings and try again.</p><button onclick="initializeMarketOverview()" class="btn">Retry</button></div>`;
      }
    }

    async function runAnalysis(type){
      const sym = (document.getElementById('assetInput').value || localStorage.getItem('LAST_SYMBOL') || 'SPY').toUpperCase();
      const section = document.getElementById('resultsSection');
      const out = document.getElementById('analysisResult');
      section.style.display = 'block';
      out.innerHTML = `<div class="loading"><div class="spinner"></div><span>Fetching market data and generating AI analysis...</span></div>`;
      section.scrollIntoView({ behavior: 'smooth' });

      try{
        const mkt = await fetchQuote(sym);
        const d1 = await loadCandles(sym,'1day',250);
        const ctx = { ...mkt, rsi: rsi14(d1), atr: atr14(d1) };

        const prompts = FIN_PROMPTS(sym, ctx);
        const prompt = prompts[type] || prompts['market-conditions'];

        // Multi-timeframe ribbon (best-effort)
        let ribbonHtml = '';
        try{
          const tfs = await multiTF(sym);
          ribbonHtml = Object.entries(tfs).map(([k,v])=>{
            if(v.rsi==null) return `<span style="margin-right:10px">${k}: n/a</span>`;
            const r = v.rsi;
            const badge = r<30?'üü¢ <30': r>70?'üî¥ >70':'üü° 30‚Äì70';
            return `<span style="margin-right:10px">${k}: ${badge}</span>`;
          }).join('');
        }catch(_){ ribbonHtml = ''; }

        const ai = await callOpenAI(prompt, mkt);

        const fresh = ageMeta(mkt.lastUpdate);
        const rel = Math.round(reliabilityScore(mkt.source)*100);

        out.innerHTML = `
          <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px">
            <span style="background:${fresh.color};color:#0b1020;padding:2px 8px;border-radius:999px;font-weight:700">Data age ${fresh.label}</span>
            <span style="color:#94a3b8">Source: ${mkt.source} ‚Ä¢ Reliability ${rel}%</span>
          </div>
          ${ribbonHtml ? `<div style="margin-bottom:8px;color:#94a3b8">RSI(14) by timeframe ‚Üí ${ribbonHtml}</div>`:''}
${ai}
          <div style="margin-top:14px;padding:12px;border:1px dashed #334155;border-radius:8px">
            <div style="font-weight:700;margin-bottom:6px">What-if / Position sizing (1‚Äì2% risk rule)</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
              <label>Acct $ <input id="acct" type="number" value="10000" style="width:110px;background:#0b1220;border:1px solid #334155;color:#fff;border-radius:6px;padding:6px"></label>
              <label>Risk % <input id="riskp" type="number" value="1.0" step=".5" style="width:80px;background:#0b1220;border:1px solid #334155;color:#fff;border-radius:6px;padding:6px"></label>
              <label>Stop @ <input id="stop" type="number" value="${(mkt.price*0.985).toFixed(2)}" step=".01" style="width:100px;background:#0b1220;border:1px solid #334155;color:#fff;border-radius:6px;padding:6px"></label>
              <button class="btn" id="sizeBtn">Calc size</button>
              <span id="sizeOut" class="note"></span>
            </div>
          </div>
        `;

        document.getElementById('sizeBtn').onclick = ()=>{
          const acct = +document.getElementById('acct').value;
          const riskp = +document.getElementById('riskp').value/100;
          const stop = +document.getElementById('stop').value;
          const perShare = Math.max(0.01, Math.abs(mkt.price - stop));
          const qty = Math.floor((acct*riskp)/perShare);
          document.getElementById('sizeOut').textContent = `Max shares ‚âà ${qty} (risk $${(acct*riskp).toFixed(0)})`;
        };

      }catch(err){
        console.error('Analysis error', err);
        out.innerHTML = `<div style="color:#f59e0b;margin-bottom:10px">‚ö†Ô∏è Analysis temporarily unavailable.</div><div>${err.message}</div>`;
      }
    }
    window.runAnalysis = runAnalysis;

    /* ==============================
       TRADINGVIEW WIDGETS
    ===============================*/
    function tvMapSymbol(sym){
      const s = (sym||'AAPL').toUpperCase();
      if(s==='NAS100' || s==='NDX') return 'NASDAQ:NDX';
      const map = { AAPL:'NASDAQ:AAPL', MSFT:'NASDAQ:MSFT', GOOGL:'NASDAQ:GOOGL', AMZN:'NASDAQ:AMZN', META:'NASDAQ:META', NVDA:'NASDAQ:NVDA', TSLA:'NASDAQ:TSLA', NFLX:'NASDAQ:NFLX', QQQ:'NASDAQ:QQQ', SPY:'AMEX:SPY' };
      return map[s] || s;
    }
    function injectTVWidget(containerId, src, config){
      const container = document.getElementById(containerId);
      if(!container) return;
      container.innerHTML = '';
      const inner = document.createElement('div');
      inner.className = 'tradingview-widget-container__widget';
      container.appendChild(inner);
      const s = document.createElement('script');
      s.type = 'text/javascript'; s.async = true; s.src = src; s.text = JSON.stringify(config);
      container.appendChild(s);
    }
    function renderTVTicker(){
      const symbols = [
        { proName:'NASDAQ:AAPL', title:'AAPL' },
        { proName:'NASDAQ:MSFT', title:'MSFT' },
        { proName:'NASDAQ:GOOGL', title:'GOOGL' },
        { proName:'NASDAQ:AMZN', title:'AMZN' },
        { proName:'NASDAQ:META', title:'META' },
        { proName:'NASDAQ:NVDA', title:'NVDA' },
        { proName:'NASDAQ:TSLA', title:'TSLA' },
        { proName:'NASDAQ:QQQ', title:'QQQ' },
        { proName:'AMEX:SPY', title:'SPY' }
      ];
      injectTVWidget('tvTicker','https://s3.tradingview.com/external-embedding/embed-widget-ticker-tape.js',{
        symbols, showSymbolLogo:true, isTransparent:false, largeChartUrl:'', displayMode:'adaptive', colorTheme:'dark', locale:'en'
      });
    }
    function renderTVAdvanced(sym){
      const symbol = tvMapSymbol(sym);
      injectTVWidget('tvAdvanced','https://s3.tradingview.com/external-embedding/embed-widget-advanced-chart.js',{
        allow_symbol_change:true, calendar:false, details:false,
        hide_side_toolbar:true, hide_top_toolbar:false, hide_legend:false, hide_volume:false,
        interval:'D', locale:'en', style:'1', symbol, theme:'dark', timezone:'Etc/UTC', autosize:true
      });
    }
    function renderTVOverview(){
      injectTVWidget('tvOverview','https://s3.tradingview.com/external-embedding/embed-widget-symbol-overview.js',{
        lineWidth:2, lineType:0, chartType:'area', colorTheme:'dark', isTransparent:false, locale:'en', autosize:true,
        symbols:[
          ['Apple','NASDAQ:AAPL|1D'], ['Google','NASDAQ:GOOGL|1D'], ['Microsoft','NASDAQ:MSFT|1D'],
          ['NASDAQ:TSLA|1D'], ['NASDAQ:META|1D'], ['NASDAQ:AMZN|1D'], ['NASDAQ:NVDA|1D'], ['AMEX:SPY|1D'], ['NASDAQ:QQQ|1D']
        ]
      });
    }
    function renderTVTimeline(){ injectTVWidget('tvTimeline','https://s3.tradingview.com/external-embedding/embed-widget-timeline.js',{ displayMode:'regular', feedMode:'all_symbols', colorTheme:'dark', isTransparent:false, locale:'en', width:'100%', height:550 }); }
    function renderTVEvents(){ injectTVWidget('tvEvents','https://s3.tradingview.com/external-embedding/embed-widget-events.js',{ colorTheme:'dark', isTransparent:false, locale:'en', countryFilter:'us,gb,eu,ca,jp', importanceFilter:'-1,0,1', width:'100%', height:550 }); }
    function renderTVScreener(){ injectTVWidget('tvScreener','https://s3.tradingview.com/external-embedding/embed-widget-screener.js',{ market:'forex', showToolbar:true, defaultColumn:'overview', defaultScreen:'general', isTransparent:false, locale:'en', colorTheme:'dark', width:'100%', height:550 }); }
    function renderTVHeatmap(){ injectTVWidget('tvHeatmap','https://s3.tradingview.com/external-embedding/embed-widget-stock-heatmap.js',{ dataSource:'SPX500', blockSize:'market_cap_basic', blockColor:'change', grouping:'sector', locale:'en', colorTheme:'dark', width:'100%', height:'100%', isZoomEnabled:true }); }
    function renderTVQuotes(){ injectTVWidget('tvQuotes','https://s3.tradingview.com/external-embedding/embed-widget-market-quotes.js',{ colorTheme:'dark', locale:'en', isTransparent:false, showSymbolLogo:true, backgroundColor:'#0F0F0F', width:'100%', height:550, symbolsGroups:[ {name:'Indices',symbols:[ {name:'FOREXCOM:SPXUSD',displayName:'S&P 500 Index'},{name:'FOREXCOM:NSXUSD',displayName:'US 100 Cash CFD'},{name:'NASDAQ:QQQ',displayName:'QQQ'} ]}, {name:'Forex',symbols:[ {name:'FX:EURUSD',displayName:'EURUSD'},{name:'FX:GBPUSD',displayName:'GBPUSD'},{name:'FX:USDJPY',displayName:'USDJPY'} ]} ] }); }
    function renderTVTechnicals(){ injectTVWidget('tvTechnicals','https://s3.tradingview.com/external-embedding/embed-widget-technical-analysis.js',{ colorTheme:'dark', displayMode:'single', isTransparent:false, locale:'en', interval:'1m', disableInterval:false, width:'100%', height:450, symbol:'NASDAQ:NDX', showIntervalTabs:true }); }
    function renderTVAll(sym){
      renderTVTicker(); renderTVAdvanced(sym||currentSymbol());
      renderTVOverview(); renderTVTimeline(); renderTVEvents();
      renderTVScreener(); renderTVHeatmap(); renderTVQuotes(); renderTVTechnicals();
    }

    /* ==============================
       BOOTSTRAP
    ===============================*/
    function currentSymbol(){ return (document.getElementById('assetInput').value || 'AAPL').toUpperCase(); }

    document.addEventListener('DOMContentLoaded', () => {
      // Settings wiring
      document.getElementById('tdKeyInput').value = settings.tdKey;
      document.getElementById('openaiEndpointInput').value = settings.openaiEndpoint;
      document.getElementById('tdDirectCheckbox').checked = settings.tdDirect;
      document.getElementById('autoRunCheckbox').checked = settings.autoRun;
      document.getElementById('saveSettingsBtn').onclick = () => {
        settings.tdKey = document.getElementById('tdKeyInput').value.trim();
        settings.openaiEndpoint = document.getElementById('openaiEndpointInput').value.trim() || `${API}/openai`;
        settings.tdDirect = document.getElementById('tdDirectCheckbox').checked;
        settings.autoRun = document.getElementById('autoRunCheckbox').checked;
        localStorage.setItem('TD_KEY', settings.tdKey);
        localStorage.setItem('OPENAI_ENDPOINT', settings.openaiEndpoint);
        localStorage.setItem('TD_DIRECT', JSON.stringify(settings.tdDirect));
        localStorage.setItem('AUTO_RUN', JSON.stringify(settings.autoRun));
        settingsLog('‚úÖ Settings saved');
      };
      document.getElementById('toggleSettingsBtn').onclick = () => {
        const s = document.getElementById('settings');
        s.style.display = s.style.display === 'none' ? 'block' : 'none';
      };

      // TradingView
      try { renderTVAll(localStorage.getItem('LAST_SYMBOL') || (location.hash||'').replace('#','') || 'AAPL'); }
      catch(e){ console.warn('TV widgets error', e); }

      // Overview
      initializeMarketOverview();

      // Quick picks
      document.getElementById('quickSymbols')?.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-sym]'); if(!btn) return; setAsset(btn.dataset.sym);
      });

      // Prompt cards
      document.querySelectorAll('.prompt-card').forEach(card=>{
        card.addEventListener('click', ()=> runAnalysis(card.getAttribute('data-analysis')));
      });

      // Toolbar
      document.getElementById('refreshBtn').onclick = () => {
        marketDataCache.clear(); initializeMarketOverview();
        const s = (document.getElementById('assetInput').value||'AAPL').toUpperCase();
        renderTVAdvanced(s);
      };
      document.getElementById('analyzeNowBtn').onclick = () => runAnalysis('market-conditions');
      document.getElementById('selfTestBtn').onclick = async () => {
        const sym = 'AAPL';
        try { const q = await fetchQuote(sym); settingsLog(`SelfTest ‚úì quote ${sym}: $${q.price}`); }
        catch(e){ settingsLog('SelfTest ‚úó quote: '+e.message); }
        try {
          const r = await fetch(settings.openaiEndpoint, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({prompt:'ping', model:'gpt-5-thinking', max_tokens:5})});
          if(!r.ok) throw new Error(r.statusText);
          settingsLog('SelfTest ‚úì openai proxy reachable');
        } catch(e){ settingsLog('SelfTest ‚úó openai proxy: '+e.message); }
      };

      // Default symbol
      const initial = localStorage.getItem('LAST_SYMBOL') || (location.hash||'').replace('#','') || 'AAPL';
      document.getElementById('assetInput').value = initial;
      if(settings.autoRun){ runAnalysis('market-conditions'); }
    });
  </script>
</body>
</html>
