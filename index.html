<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Professional Trading Analysis Platform</title>
  <style>
    /* ... your original CSS unchanged ... */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); min-height:100vh; color:#333; }
    .container { max-width:1400px; margin:0 auto; padding:20px; }
    .header { text-align:center; color:#fff; margin-bottom:30px; }
    .header h1 { font-size:2.5rem; margin-bottom:10px; }
    .header p { font-size:1.2rem; opacity:.9; }
    .search-section { background:#fff; border-radius:15px; padding:30px; margin-bottom:30px; box-shadow:0 10px 30px rgba(0,0,0,.1); }
    .search-bar { display:flex; gap:15px; margin-bottom:20px; }
    .search-input { flex:1; padding:15px; border:2px solid #e1e8ed; border-radius:10px; font-size:16px; transition:border-color .3s; }
    .search-input:focus{ outline:none; border-color:#667eea; }
    .search-btn{ padding:15px 30px; background:linear-gradient(135deg,#667eea 0%, #764ba2 100%); color:#fff; border:none; border-radius:10px; font-size:16px; cursor:pointer; transition:transform .2s; }
    .search-btn:hover{ transform:translateY(-2px); }
    .analysis-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:20px; margin-bottom:30px; }
    .analysis-card{ background:#fff; border-radius:15px; padding:25px; box-shadow:0 5px 15px rgba(0,0,0,.1); transition:transform .3s, box-shadow .3s; cursor:pointer; border:2px solid transparent; }
    .analysis-card:hover{ transform:translateY(-5px); box-shadow:0 15px 35px rgba(0,0,0,.15); border-color:#667eea; }
    .analysis-card.active{ border-color:#667eea; background:linear-gradient(135deg,#f8f9ff 0%, #e8f2ff 100%); }
    .card-icon{ font-size:2.5rem; margin-bottom:15px; display:block; }
    .card-title{ font-size:1.3rem; font-weight:bold; margin-bottom:10px; color:#333; }
    .card-description{ color:#666; line-height:1.5; }
    .results-section{ background:#fff; border-radius:15px; padding:30px; box-shadow:0 10px 30px rgba(0,0,0,.1); min-height:400px; }
    .results-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; padding-bottom:15px; border-bottom:2px solid #f0f0f0; }
    .results-title{ font-size:1.8rem; color:#333; }
    .loading{ display:flex; flex-direction:column; align-items:center; justify-content:center; height:300px; }
    .spinner{ width:50px; height:50px; border:4px solid #f3f3f3; border-top:4px solid #667eea; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:20px; }
    @keyframes spin{ 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .market-data{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
    .data-card{ background:linear-gradient(135deg,#f8f9ff 0%, #e8f2ff 100%); padding:20px; border-radius:10px; text-align:center; border-left:4px solid #667eea; }
    .data-value{ font-size:1.8rem; font-weight:bold; color:#333; margin-bottom:5px; }
    .data-label{ color:#666; font-size:.9rem; }
    .positive{ color:#10b981; } .negative{ color:#ef4444; }
    .analysis-content{ line-height:1.8; font-size:1.1rem; }
    .analysis-content h3{ color:#667eea; margin:20px 0 10px; }
    .analysis-content ul{ margin-left:20px; margin-bottom:15px; }
    .signal-badge{ display:inline-block; padding:8px 16px; border-radius:20px; font-weight:bold; margin:5px 5px 5px 0; }
    .signal-buy{ background:#10b981; color:#fff; } .signal-sell{ background:#ef4444; color:#fff; } .signal-hold{ background:#f59e0b; color:#fff; }
    .confidence-bar{ background:#e5e7eb; height:8px; border-radius:4px; margin:10px 0; overflow:hidden; }
    .confidence-fill{ height:100%; background:linear-gradient(90deg,#10b981 0%, #667eea 100%); transition:width .5s ease; }
    .ai-block{ margin-top:18px; padding:16px; background:#f6f7ff; border:1px solid #dfe3ff; border-radius:10px; }
    .ai-title{ font-weight:700; color:#3b5bcc; margin-bottom:8px; }
    pre.ai-out{ white-space:pre-wrap; line-height:1.6; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color:#1f2937; }
    @media (max-width:768px){ .search-bar{flex-direction:column} .analysis-grid{grid-template-columns:1fr} .market-data{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ Professional Trading Analysis</h1>
      <p>Advanced market analysis with real-time insights and AI-powered recommendations</p>
    </div>

    <div class="search-section">
      <div class="search-bar">
        <input type="text" class="search-input" id="symbolInput" placeholder="Enter stock symbol (e.g., AAPL, TSLA, NVDA)" value="NVDA">
        <button class="search-btn" onclick="fetchMarketData()">Analyze Stock</button>
      </div>
    </div>

    <div class="analysis-grid">
      <div class="analysis-card" onclick="runAnalysis('market-conditions')"><span class="card-icon">üìà</span><div class="card-title">Market Conditions Analysis</div><div class="card-description">Get data-driven insights on current market conditions</div></div>
      <div class="analysis-card" onclick="runAnalysis('position-logic')"><span class="card-icon">üß†</span><div class="card-title">Position Logic Check</div><div class="card-description">Remove bias with objective position analysis</div></div>
      <div class="analysis-card" onclick="runAnalysis('news-impact')"><span class="card-icon">‚ö†Ô∏è</span><div class="card-title">News Impact Summary</div><div class="card-description">Automate news gathering and impact analysis</div></div>
      <div class="analysis-card" onclick="runAnalysis('technical-indicators')"><span class="card-icon">üìä</span><div class="card-title">Technical Indicators</div><div class="card-description">Identify key technical signals quickly</div></div>
      <div class="analysis-card" onclick="runAnalysis('decision-pros-cons')"><span class="card-icon">üéØ</span><div class="card-title">Decision Pros & Cons</div><div class="card-description">Get balanced perspective on trading decisions</div></div>
      <div class="analysis-card" onclick="runAnalysis('emerging-trends')"><span class="card-icon">üîç</span><div class="card-title">Emerging Trends</div><div class="card-description">Spot opportunities before they go mainstream</div></div>
      <div class="analysis-card" onclick="runAnalysis('strategy-simplification')"><span class="card-icon">üìö</span><div class="card-title">Strategy Simplification</div><div class="card-description">Break down complex strategies into actionable steps</div></div>
      <div class="analysis-card" onclick="runAnalysis('risk-assessment')"><span class="card-icon">üí∞</span><div class="card-title">Risk Assessment</div><div class="card-description">Evaluate risk factors for potential trades</div></div>
    </div>

    <div class="results-section">
      <div class="results-header">
        <h2 class="results-title">Analysis Results</h2>
        <button class="search-btn" id="aiAnalyzeBtn" title="Run AI analysis on the current view">ü§ñ Run AI Analysis</button>
      </div>
      <div id="resultsContent">
        <p style="text-align:center; color:#666; font-size:1.2rem; margin-top:100px;">
          Select a stock symbol and choose an analysis type to get started üìä
        </p>
      </div>
    </div>
  </div>

  <script>
    /* ================== OPENAI ENDPOINT ================== */
    const OPENAI_ENDPOINT = '/.netlify/functions/openai'; // <-- your Netlify function path

    async function callOpenAI(prompt) {
      const r = await fetch(OPENAI_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt })
      });
      const text = await r.text();
      let j;
      try { j = JSON.parse(text); } catch { throw new Error(text || 'Non-JSON from server'); }
      if (!r.ok) throw new Error(j.error || j.details || 'OpenAI proxy error');
      return j.content || j.text || '';
    }

    function buildPrompt(analysisType, data) {
      const header = `You are a cautious trading explainer. Respond in concise Markdown with headings and bullets. Include risk warnings; no financial advice.`;
      const snapshot = `Snapshot: ${data.symbol} | Price $${data.price.toFixed(2)} | Change ${data.changePercent.toFixed(2)}% | Range ${data.low.toFixed(2)}‚Äì${data.high.toFixed(2)} | Vol ${data.volume.toLocaleString()} | Sector ${data.sector}.`;
      const intents = {
        'market-conditions': `Analyze current market conditions, momentum, volatility, and likely near-term scenarios.`,
        'position-logic': `Entry/exit logic with stops/targets and position sizing considerations.`,
        'news-impact': `What catalysts might explain the move; how durable is sentiment?`,
        'technical-indicators': `Trend, momentum, key S/R, and risk checkpoints.`,
        'decision-pros-cons': `Pros/cons of a position right now; risk/reward framing.`,
        'emerging-trends': `Sector/context trends and what to monitor next.`,
        'strategy-simplification': `Simple rules-based plan: entries, exits, sizing, review cadence.`,
        'risk-assessment': `Volatility, liquidity, gap/overnight risk; suggested sizing bands.`
      };
      return `${header}\n\n${snapshot}\n\nFocus: ${intents[analysisType] || 'Comprehensive, actionable trading notes.'}`;
    }

    /* ================== YOUR ORIGINAL APP CODE (mock data + UI) ================== */
    let currentMarketData = null;
    let analysisCache = new Map();
    const CACHE_DURATION = 300000;

    const TradingFormulas = {
      momentumScore: (changePercent) => Math.min(100, Math.abs(changePercent) * 10),
      volatilityIndex: (high, low, price) => ((high - low) / price) * 100,
      volumeProfile: (currentVolume, avgVolume = 1000000) => currentVolume / avgVolume,
      supportResistance: (price) => ({
        immediateSupport: price * 0.985,
        immediateResistance: price * 1.015,
        strongSupport: price * 0.97,
        strongResistance: price * 1.03
      }),
      riskRewardRatio: (entryPrice, targetPrice, stopLoss) =>
        (targetPrice - entryPrice) / (entryPrice - stopLoss),
      rsi: (changePercent) => {
        const gain = changePercent > 0 ? changePercent : 0;
        const loss = changePercent < 0 ? Math.abs(changePercent) : 0;
        const rs = gain / (loss || 0.01);
        return 100 - (100 / (1 + rs));
      },
      atrStopLoss: (price, atr, multiplier = 2) => ({ long: price - (atr * multiplier), short: price + (atr * multiplier) }),
      positionSize: (portfolioValue, riskPercent, entryPrice, stopLoss) =>
        (portfolioValue * riskPercent / 100) / Math.abs(entryPrice - stopLoss),
      trendStrength: (currentPrice, price20DaysAgo) =>
        Math.abs((currentPrice - price20DaysAgo) / price20DaysAgo * 100),
      bollingerBands: (price, volatility) => ({ upper: price + (volatility * 2), middle: price, lower: price - (volatility * 2) })
    };

    function generateMarketData(symbol) {
      const basePrice = Math.random() * 500 + 50;
      const changePercent = (Math.random() - 0.5) * 10;
      const change = basePrice * (changePercent / 100);
      const volume = Math.floor(Math.random() * 50000000 + 1000000);
      const high = basePrice + Math.random() * 10;
      const low = basePrice - Math.random() * 10;
      return {
        symbol: symbol.toUpperCase(),
        name: getCompanyName(symbol),
        price: basePrice,
        change,
        changePercent,
        high, low, volume,
        marketCap: formatMarketCap(basePrice * 1000000000),
        sector: getSector(symbol),
        timestamp: new Date().toISOString()
      };
    }

    function getCompanyName(symbol) {
      const companies = { AAPL:'Apple Inc.', TSLA:'Tesla, Inc.', NVDA:'NVIDIA Corporation', MSFT:'Microsoft Corporation', GOOGL:'Alphabet Inc.', AMZN:'Amazon.com, Inc.', META:'Meta Platforms, Inc.', NFLX:'Netflix, Inc.' };
      return companies[symbol.toUpperCase()] || `${symbol.toUpperCase()} Corporation`;
    }
    function getSector(symbol) {
      const sectors = { AAPL:'Technology', TSLA:'Automotive/Clean Energy', NVDA:'Semiconductors', MSFT:'Technology', GOOGL:'Technology', AMZN:'E-commerce/Cloud', META:'Social Media', NFLX:'Entertainment' };
      return sectors[symbol.toUpperCase()] || 'Technology';
    }
    function formatMarketCap(value) {
      if (value >= 1e12) return `$${(value / 1e12).toFixed(1)}T`;
      if (value >= 1e9) return `$${(value / 1e9).toFixed(1)}B`;
      if (value >= 1e6) return `$${(value / 1e6).toFixed(1)}M`;
      return `$${value.toLocaleString()}`;
    }

    async function fetchMarketData() {
      const symbol = document.getElementById('symbolInput').value.trim();
      if (!symbol) { alert('Please enter a stock symbol'); return; }
      showLoading('Fetching market data...');
      setTimeout(() => {
        currentMarketData = generateMarketData(symbol);
        displayMarketData(currentMarketData);
      }, 800);
    }

    function displayMarketData(data) {
      const isPositive = data.changePercent >= 0;
      const changeClass = isPositive ? 'positive' : 'negative';
      const changeSign = isPositive ? '+' : '';
      const marketDataHTML = `
        <div class="market-data">
          <div class="data-card"><div class="data-value">${data.symbol}</div><div class="data-label">${data.name}</div></div>
          <div class="data-card"><div class="data-value">$${data.price.toFixed(2)}</div><div class="data-label">Current Price</div></div>
          <div class="data-card"><div class="data-value ${changeClass}">${changeSign}$${data.change.toFixed(2)}</div><div class="data-label">Daily Change</div></div>
          <div class="data-card"><div class="data-value ${changeClass}">${changeSign}${data.changePercent.toFixed(2)}%</div><div class="data-label">Percentage Change</div></div>
          <div class="data-card"><div class="data-value">${data.volume.toLocaleString()}</div><div class="data-label">Volume</div></div>
          <div class="data-card"><div class="data-value">${data.marketCap}</div><div class="data-label">Market Cap</div></div>
        </div>
        <p style="text-align:center; color:#666; margin-top:20px;">Select an analysis type above to get detailed insights üìä</p>
      `;
      document.getElementById('resultsContent').innerHTML = marketDataHTML;
    }

    function runAnalysis(analysisType) {
      if (!currentMarketData) { alert('Fetch market data first'); return; }
      document.querySelectorAll('.analysis-card').forEach(card => card.classList.remove('active'));
      event.target.closest('.analysis-card').classList.add('active');
      showLoading('Running analysis...');

      setTimeout(async () => {
        const analysis = performAnalysis(analysisType, currentMarketData);
        displayAnalysis(analysis, analysisType);
        // Kick off AI analysis (non-blocking)
        appendAIAnalysis(analysisType, currentMarketData);
      }, 600);
    }

    function performAnalysis(type, data) {
      const momentum = TradingFormulas.momentumScore(data.changePercent);
      const volatility = TradingFormulas.volatilityIndex(data.high, data.low, data.price);
      const volumeProfile = TradingFormulas.volumeProfile(data.volume);
      const levels = TradingFormulas.supportResistance(data.price);
      const rsi = TradingFormulas.rsi(data.changePercent);
      switch(type) {
        case 'market-conditions': return generateMarketConditionsAnalysis(data, momentum, volatility, volumeProfile, levels);
        case 'position-logic': return generatePositionLogicAnalysis(data, momentum, volatility, levels);
        case 'news-impact': return generateNewsImpactAnalysis(data, volatility);
        case 'technical-indicators': return generateTechnicalIndicatorsAnalysis(data, momentum, volatility, rsi, levels);
        case 'decision-pros-cons': return generateDecisionAnalysis(data, momentum, volatility);
        case 'emerging-trends': return generateEmergingTrendsAnalysis(data, momentum, volumeProfile);
        case 'strategy-simplification': return generateStrategyAnalification(data, levels);
        case 'risk-assessment': return generateRiskAssessmentAnalysis(data, volatility, levels);
        default: return { content:'Analysis type not found', signal:'HOLD', confidence:50 };
      }
    }

    /* === (your generator functions unchanged) === */
    /* ... generateMarketConditionsAnalysis / generatePositionLogicAnalysis / generateTechnicalIndicatorsAnalysis /
            generateNewsImpactAnalysis / generateDecisionAnalysis / generateEmergingTrendsAnalysis /
            generateStrategyAnalification / generateRiskAssessmentAnalysis ... (same as your code) ... */

    // -- keep your existing helper fns getSectorTrend/getInnovationScore/getMarketTiming/... unchanged --

    function showLoading(message) {
      document.getElementById('resultsContent').innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>${message}</p>
        </div>`;
    }

    function displayAnalysis(analysisResult) {
      const { content, signal, confidence } = analysisResult;
      const signalClass = signal === 'BUY' ? 'signal-buy' : signal === 'SELL' ? 'signal-sell' : 'signal-hold';
      const analysisHTML = `
        <div class="analysis-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
          <div>
            <span class="signal-badge ${signalClass}">${signal}</span>
            <span style="margin-left:10px; color:#666;">Confidence: ${confidence.toFixed(0)}%</span>
          </div>
          <div class="confidence-bar" style="width:200px;">
            <div class="confidence-fill" style="width:${confidence}%"></div>
          </div>
        </div>
        <div class="analysis-content">${content}</div>
        <div class="ai-block" id="aiBlock" style="display:none">
          <div class="ai-title">ü§ñ AI Perspective</div>
          <pre class="ai-out" id="aiOut">Loading‚Ä¶</pre>
          <div style="margin-top:8px; color:#6b7280; font-size:.85rem">Note: Educational content only. Not financial advice.</div>
        </div>
        <div style="margin-top:30px; padding:20px; background:#f8f9fa; border-radius:10px; border-left:4px solid #667eea;">
          <h4 style="margin-bottom:10px; color:#333;">‚ö†Ô∏è Important Disclaimer</h4>
          <p style="margin:0; color:#666; font-size:.9rem;">
            This analysis is for educational purposes only and should not be considered financial advice.
            Always do your own research and consider your risk tolerance. Past performance does not guarantee future results.
          </p>
        </div>`;
      document.getElementById('resultsContent').innerHTML = analysisHTML;
    }

    async function appendAIAnalysis(analysisType, data) {
      const blk = document.getElementById('aiBlock');
      const out = document.getElementById('aiOut');
      if (!blk || !out) return;
      blk.style.display = 'block';
      out.textContent = 'Contacting AI‚Ä¶';
      try {
        const md = await callOpenAI(buildPrompt(analysisType, data));
        out.textContent = md && md.trim() ? md : '(No content returned)';
      } catch (e) {
        out.textContent = `AI call failed: ${e.message}`;
      }
    }

    // ‚ÄúRun AI Analysis‚Äù button can be used anytime after market data is shown
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('aiAnalyzeBtn').addEventListener('click', () => {
        if (!currentMarketData) { alert('Fetch market data first'); return; }
        // If an analysis hasn‚Äôt been run yet, run a default one so the AI block exists
        if (!document.getElementById('aiBlock')) {
          const a = performAnalysis('market-conditions', currentMarketData);
          displayAnalysis(a, 'market-conditions');
        }
        appendAIAnalysis('market-conditions', currentMarketData);
      });

      // Auto-load NVDA on startup
      setTimeout(fetchMarketData, 600);

      document.getElementById('symbolInput').addEventListener('keypress', e => {
        if (e.key === 'Enter') fetchMarketData();
      });

      setInterval(() => {
        if (currentMarketData && !document.querySelector('.analysis-card.active')) {
          const symbol = currentMarketData.symbol;
          currentMarketData = generateMarketData(symbol);
          displayMarketData(currentMarketData);
        }
      }, 30000);
    });

    document.addEventListener('click', function(e) {
      if (e.target.closest('.analysis-card')) {
        const card = e.target.closest('.analysis-card');
        card.style.transform = 'scale(0.98)';
        setTimeout(() => { card.style.transform = ''; }, 150);
      }
    });

    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
          case '1': e.preventDefault(); runAnalysis('market-conditions'); break;
          case '2': e.preventDefault(); runAnalysis('position-logic'); break;
          case '3': e.preventDefault(); runAnalysis('technical-indicators'); break;
          case '4': e.preventDefault(); runAnalysis('risk-assessment'); break;
        }
      }
    });

    // Optional export remains
    function exportAnalysis(){ /* unchanged */ }
    window.exportAnalysis = exportAnalysis;
  </script>
</body>
</html>
