<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Trading Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script id="app-config" type="application/json">{
    "API_BASE": "/.netlify/functions",
    "AUTO_RUN_ANALYSIS": true
  }</script>
  <style>
    .fade-in { animation: fadeIn .45s ease-in; }
    @keyframes fadeIn { from {opacity:.0; transform: translateY(8px);} to {opacity:1; transform:none;} }
  </style>
</head>
<body class="bg-gray-950 text-white min-h-screen">
  <div class="max-w-6xl mx-auto p-4">
    <header class="text-center mb-6 fade-in">
      <h1 class="text-4xl font-bold">AI Trading Dashboard</h1>
      <p class="text-gray-400 mt-1">Quotes, news, tweets, events in one place</p>
    </header>

    <section class="mb-5 fade-in">
      <input id="search" placeholder="Search symbol, try AAPL" class="w-full p-3 bg-gray-900 border border-gray-700 rounded-lg" />
      <div id="suggest" class="absolute bg-gray-900 border border-gray-700 rounded mt-1 hidden max-h-64 overflow-auto"></div>
    </section>

    <section class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 fade-in">
      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <h3 class="font-semibold mb-3">News and Events</h3>
        <div class="flex gap-2 mb-3">
          <button class="tab px-3 py-2 bg-blue-600 rounded" data-tab="cnbc">CNBC</button>
          <button class="tab px-3 py-2 bg-gray-800 rounded" data-tab="x">Tweets</button>
          <button class="tab px-3 py-2 bg-gray-800 rounded" data-tab="fx">Forex</button>
        </div>
        <div id="panel-cnbc" class="space-y-3"></div>
        <div id="panel-x" class="space-y-3 hidden"></div>
        <div id="panel-fx" class="space-y-3 hidden"></div>
      </div>

      <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
        <h3 class="font-semibold mb-3">AI Analysis</h3>
        <div class="flex gap-2 mb-3">
          <input id="asset" class="flex-1 p-2 bg-gray-800 border border-gray-700 rounded" placeholder="Symbol, e.g., AAPL" />
          <button id="analyze" class="px-3 py-2 bg-green-600 rounded">Run</button>
        </div>
        <pre id="ai" class="bg-black/60 rounded p-3 text-sm whitespace-pre-wrap"></pre>
      </div>
    </section>

    <footer class="text-center text-gray-500 mt-8">Educational only</footer>
  </div>

  <script>
    const cfg = JSON.parse(document.getElementById("app-config").textContent);
    const API = cfg.API_BASE;

    // tiny helpers
    const qs = (s) => document.querySelector(s);
    const el = (h) => { const d = document.createElement('div'); d.innerHTML = h; return d.firstElementChild; };

    // tabs
    document.querySelectorAll(".tab").forEach(b => {
      b.addEventListener("click", () => {
        document.querySelectorAll(".tab").forEach(x => x.classList.remove("bg-blue-600"));
        b.classList.add("bg-blue-600");
        ["cnbc","x","fx"].forEach(t => qs("#panel-"+t).classList.toggle("hidden", t !== b.dataset.tab));
      });
    });

    // autocomplete
    const search = qs("#search");
    const suggest = qs("#suggest");
    let suggestTimer;
    search.addEventListener("input", async e => {
      clearTimeout(suggestTimer);
      const q = e.target.value.trim();
      if (q.length < 2) { suggest.classList.add("hidden"); return; }
      suggestTimer = setTimeout(async () => {
        const r = await fetch(`${API}/search-symbols?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        const list = (data?.data || data?.best_matches || data?.symbols || data?.matches || [])
          .slice(0, 12)
          .map(s => s.symbol || s.instrument || s?.["1. symbol"] || "")
          .filter(Boolean);

        suggest.innerHTML = list.map(sym => `<div class="p-2 hover:bg-gray-800 cursor-pointer">${sym}</div>`).join("");
        suggest.classList.remove("hidden");
        Array.from(suggest.children).forEach(row => row.addEventListener("click", () => {
          qs("#asset").value = row.textContent.trim();
          suggest.classList.add("hidden");
          loadPanels(row.textContent.trim());
        }));
      }, 200);
    });
    search.addEventListener("blur", () => setTimeout(() => suggest.classList.add("hidden"), 200));

    // panels
    async function loadPanels(symbol = "AAPL") {
      const [cnbcEl, xEl, fxEl] = [qs("#panel-cnbc"), qs("#panel-x"), qs("#panel-fx")];
      cnbcEl.innerHTML = `<div class="text-gray-400">Loading...</div>`;
      xEl.innerHTML = `<div class="text-gray-400">Loading...</div>`;
      fxEl.innerHTML = `<div class="text-gray-400">Loading...</div>`;

      // CNBC
      try {
        const r = await fetch(`${API}/cnbc-news?symbol=${encodeURIComponent(symbol)}`);
        const data = await r.json();
        cnbcEl.innerHTML = (data?.articles || []).map(a => `
          <a href="${a.url}" target="_blank" class="block p-3 bg-gray-800 rounded hover:bg-gray-700">
            <div class="font-medium">${a.title || "Untitled"}</div>
            <div class="text-gray-400 text-sm">${a?.source?.name || "CNBC"} â€¢ ${a?.publishedAt || ""}</div>
            <div class="text-gray-300 text-sm mt-1">${a.description || ""}</div>
          </a>
        `).join("") || `<div class="text-gray-400">No news</div>`;
      } catch(e) {
        cnbcEl.innerHTML = `<div class="text-red-400">News error, check key</div>`;
      }

      // Tweets
      try {
        const q = `${symbol} lang:en -is:retweet`;
        const r = await fetch(`${API}/x-tweets?q=${encodeURIComponent(q)}`);
        const data = await r.json();
        const list = data?.data || data?.tweets || [];
        xEl.innerHTML = list.map(t => `
          <div class="p-3 bg-gray-800 rounded">
            <div class="text-sm text-gray-400">${new Date(t.created_at).toLocaleString()}</div>
            <div class="mt-1">${t.text || ""}</div>
          </div>
        `).join("") || `<div class="text-gray-400">No tweets or token missing</div>`;
      } catch(e) {
        xEl.innerHTML = `<div class="text-red-400">Tweets error</div>`;
      }

      // Forex events
      try {
        const today = new Date().toISOString().slice(0,10);
        const r = await fetch(`${API}/forex-calendar?date=${today}`);
        const data = await r.json();
        const events = data?.events || data || [];
        fxEl.innerHTML = events.slice(0,15).map(ev => `
          <div class="p-3 bg-gray-800 rounded">
            <div class="font-medium">${ev.title || ev.event || "Event"}</div>
            <div class="text-gray-400 text-sm">${ev.time || ""}, Impact ${ev.impact || ev.importance || ""}</div>
            <div class="text-gray-300 text-sm">${ev.country || ""} ${ev.currency || ""}</div>
          </div>
        `).join("") || `<div class="text-gray-400">No events</div>`;
      } catch(e) {
        fxEl.innerHTML = `<div class="text-red-400">Forex error</div>`;
      }
    }

    // AI analysis stub, wire to your model or proxy
    qs("#analyze").addEventListener("click", () => {
      const sym = qs("#asset").value.trim() || "AAPL";
      qs("#ai").textContent = `Run your AI call here for ${sym}. You can include the top news and tweet snippets in the prompt.`;
    });

    // bootstrap
    loadPanels("AAPL");
  </script>
</body>
</html>
